<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.or.kosa.backend.tag.mapper.TagMapper">

    <!-- 태그명으로 조회 (대소문자 구분 없음, 캐시 비활성화) -->
    <select id="findByTagName"
            resultType="kr.or.kosa.backend.tag.domain.Tag"
            useCache="false"
            flushCache="true">
        SELECT TAG_ID, TAG_NAME, POPULAR_DISPLAY_NAME, USAGE_COUNT
        FROM TAG
        WHERE LOWER(TAG_NAME) = LOWER(#{tagName})
        LIMIT 1
    </select>

    <!-- UPSERT -->
    <insert id="upsertTag" parameterType="kr.or.kosa.backend.tag.domain.Tag"
            useGeneratedKeys="true" keyProperty="tagId" keyColumn="TAG_ID">
        INSERT INTO TAG (TAG_NAME)
        VALUES (#{tagName})
        ON DUPLICATE KEY UPDATE
        TAG_ID = LAST_INSERT_ID(TAG_ID)
    </insert>

    <!-- 태그명으로 시작하는 태그 검색 (자동완성) -->
    <select id="findByTagNameStartingWith" resultType="kr.or.kosa.backend.tag.domain.Tag">
        SELECT TAG_ID, TAG_NAME, POPULAR_DISPLAY_NAME, USAGE_COUNT
        FROM TAG
        WHERE TAG_NAME LIKE CONCAT(#{keyword}, '%')
        ORDER BY USAGE_COUNT DESC, TAG_NAME
    </select>

    <!-- 가장 많이 사용된 표기 찾기 (fallback용) -->
    <select id="findMostUsedDisplayName" resultType="string">
        SELECT TAG_DISPLAY_NAME
        FROM (
        SELECT TAG_DISPLAY_NAME, COUNT(*) as cnt
        FROM CODEBOARD_TAG
        WHERE TAG_ID = #{tagId}
        GROUP BY TAG_DISPLAY_NAME
        UNION ALL
        SELECT TAG_DISPLAY_NAME, COUNT(*) as cnt
        FROM FREEBOARD_TAG
        WHERE TAG_ID = #{tagId}
        GROUP BY TAG_DISPLAY_NAME
        ) combined
        GROUP BY TAG_DISPLAY_NAME
        ORDER BY SUM(cnt) DESC
        LIMIT 1
    </select>

    <!-- 태그 사용 횟수 (fallback용) -->
    <select id="countByTagId" resultType="long">
        SELECT COUNT(*)
        FROM (
        SELECT TAG_ID FROM CODEBOARD_TAG WHERE TAG_ID = #{tagId}
        UNION ALL
        SELECT TAG_ID FROM FREEBOARD_TAG WHERE TAG_ID = #{tagId}
        ) combined
    </select>

    <!-- 사용되지 않는 태그 삭제 -->
    <delete id="deleteUnusedTags">
        DELETE FROM TAG
        WHERE TAG_ID NOT IN (
        SELECT DISTINCT TAG_ID FROM CODEBOARD_TAG
        UNION
        SELECT DISTINCT TAG_ID FROM FREEBOARD_TAG
        )
    </delete>

    <!-- 태그 통계 갱신 -->
    <update id="updateTagStatistics">
        UPDATE TAG t
        SET
        POPULAR_DISPLAY_NAME = (
        SELECT TAG_DISPLAY_NAME
        FROM (
        SELECT TAG_DISPLAY_NAME, COUNT(*) as cnt
        FROM CODEBOARD_TAG
        WHERE TAG_ID = t.TAG_ID
        GROUP BY TAG_DISPLAY_NAME
        UNION ALL
        SELECT TAG_DISPLAY_NAME, COUNT(*) as cnt
        FROM FREEBOARD_TAG
        WHERE TAG_ID = t.TAG_ID
        GROUP BY TAG_DISPLAY_NAME
        ) combined
        GROUP BY TAG_DISPLAY_NAME
        ORDER BY SUM(cnt) DESC
        LIMIT 1
        ),
        USAGE_COUNT = (
        SELECT COUNT(*)
        FROM (
        SELECT TAG_ID FROM CODEBOARD_TAG WHERE TAG_ID = t.TAG_ID
        UNION ALL
        SELECT TAG_ID FROM FREEBOARD_TAG WHERE TAG_ID = t.TAG_ID
        ) combined
        )
        WHERE EXISTS (
        SELECT 1 FROM CODEBOARD_TAG WHERE TAG_ID = t.TAG_ID
        UNION
        SELECT 1 FROM FREEBOARD_TAG WHERE TAG_ID = t.TAG_ID
        )
    </update>

</mapper>