<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.or.kosa.backend.freeboard.mapper.FreeboardMapper">

    <!-- ========================= -->
    <!-- 게시글 목록용 resultMap -->
    <!-- ========================= -->
    <resultMap id="FreeboardListResponseMap" type="kr.or.kosa.backend.freeboard.dto.FreeboardListResponseDto">
        <id property="freeboardId" column="FREEBOARD_ID"/>
        <result property="userId" column="USER_ID"/>
        <result property="userNickname" column="USER_NICKNAME"/>
        <result property="freeboardTitle" column="FREEBOARD_TITLE"/>
        <result property="freeboardSummary" column="FREEBOARD_SUMMARY"/>
        <result property="freeboardClick" column="FREEBOARD_CLICK"/>
        <result property="freeboardRepresentImage" column="FREEBOARD_REPRESENT_IMAGE"/>
        <result property="freeboardCreatedAt" column="FREEBOARD_CREATED_AT"/>
        <result property="likeCount" column="LIKE_COUNT"/>
        <result property="commentCount" column="COMMENT_COUNT"/>

        <collection property="tags" ofType="java.lang.String">
            <result column="TAG_NAME"/>
        </collection>
    </resultMap>

    <!-- ========================= -->
    <!-- 게시글 목록 (페이징) -->
    <!-- ========================= -->
    <select id="selectPage" resultMap="FreeboardListResponseMap">
        SELECT
        f.FREEBOARD_ID,
        f.USER_ID,
        f.FREEBOARD_TITLE,
        SUBSTRING(f.FREEBOARD_PLAIN_TEXT, 1, 200) AS FREEBOARD_SUMMARY,
        f.FREEBOARD_CLICK,
        f.FREEBOARD_REPRESENT_IMAGE,
        f.FREEBOARD_CREATED_AT,
        u.USER_NICKNAME,
        t.TAG_NAME,

        -- 좋아요 개수 (서브쿼리)
        COALESCE(
        (
        SELECT COUNT(*)
        FROM `LIKE` l
        WHERE l.REFERENCE_TYPE = 'POST_FREEBOARD'
        AND l.REFERENCE_ID = f.FREEBOARD_ID
        ),
        0
        ) AS LIKE_COUNT,

        -- 댓글 개수
        COALESCE(
        (
        SELECT COUNT(*)
        FROM COMMENT c
        WHERE c.BOARD_ID = f.FREEBOARD_ID
        AND c.BOARD_TYPE = 'FREEBOARD'
        AND c.IS_DELETED = FALSE
        ),
        0
        ) AS COMMENT_COUNT

        FROM FREEBOARD f
        LEFT JOIN USERS u ON f.USER_ID = u.USER_ID
        LEFT JOIN FREEBOARD_TAG ft ON f.FREEBOARD_ID = ft.FREEBOARD_ID
        LEFT JOIN TAG t ON ft.TAG_ID = t.TAG_ID
        WHERE f.FREEBOARD_DELETED_YN = 'N'
        ORDER BY f.FREEBOARD_ID DESC
        LIMIT #{size} OFFSET #{offset}
    </select>

    <!-- ========================================= -->
    <!-- 검색 / 정렬 기능이 포함된 게시글 목록 -->
    <!-- ========================================= -->
    <select id="findPosts" resultMap="FreeboardListResponseMap">
        SELECT
        f.FREEBOARD_ID,
        f.USER_ID,
        f.FREEBOARD_TITLE,
        f.FREEBOARD_CONTENT,
        SUBSTRING(f.FREEBOARD_PLAIN_TEXT, 1, 200) AS FREEBOARD_SUMMARY,  -- 이 부분 확인
        f.FREEBOARD_CLICK,
        f.FREEBOARD_REPRESENT_IMAGE,
        f.FREEBOARD_CREATED_AT,
        u.USER_NICKNAME,
        t.TAG_NAME,

        -- 좋아요 개수
        COALESCE(
        (
        SELECT COUNT(*)
        FROM `LIKE` l
        WHERE l.REFERENCE_TYPE = 'POST_FREEBOARD'
        AND l.REFERENCE_ID = f.FREEBOARD_ID
        ),
        0
        ) AS LIKE_COUNT,

        -- 댓글 개수
        COALESCE(
        (
        SELECT COUNT(*)
        FROM COMMENT c
        WHERE c.BOARD_ID = f.FREEBOARD_ID
        AND c.BOARD_TYPE = 'FREEBOARD'
        AND c.IS_DELETED = FALSE
        ),
        0
        ) AS COMMENT_COUNT

        FROM FREEBOARD f
        LEFT JOIN USERS u ON f.USER_ID = u.USER_ID
        LEFT JOIN FREEBOARD_TAG ft ON f.FREEBOARD_ID = ft.FREEBOARD_ID
        LEFT JOIN TAG t ON ft.TAG_ID = t.TAG_ID
        WHERE f.FREEBOARD_DELETED_YN = 'N'

        <if test="keyword != null and keyword != ''">
            AND (
            f.FREEBOARD_TITLE LIKE CONCAT('%', #{keyword}, '%')
            OR f.FREEBOARD_PLAIN_TEXT LIKE CONCAT('%', #{keyword}, '%')
            OR u.USER_NICKNAME LIKE CONCAT('%', #{keyword}, '%')
            OR t.TAG_NAME LIKE CONCAT('%', #{keyword}, '%')
            )
        </if>

        ORDER BY
        <choose>
            <when test="sortField == 'comment_count'">
                COMMENT_COUNT ${sortDirection}, f.FREEBOARD_CREATED_AT DESC
            </when>
            <when test="sortField == 'like_count'">
                LIKE_COUNT ${sortDirection}, f.FREEBOARD_CREATED_AT DESC
            </when>
            <when test="sortField == 'view_count'">
                f.FREEBOARD_CLICK ${sortDirection}, f.FREEBOARD_CREATED_AT DESC
            </when>
            <otherwise>
                f.FREEBOARD_CREATED_AT ${sortDirection}
            </otherwise>
        </choose>

        LIMIT #{pageSize} OFFSET #{offset}
    </select>

    <!-- ========================= -->
    <!-- 검색 조건 게시글 수 -->
    <!-- ========================= -->
    <select id="countPosts" resultType="int">
        SELECT COUNT(DISTINCT f.FREEBOARD_ID)
        FROM FREEBOARD f
        LEFT JOIN FREEBOARD_TAG ft ON f.FREEBOARD_ID = ft.FREEBOARD_ID
        LEFT JOIN TAG t ON ft.TAG_ID = t.TAG_ID
        LEFT JOIN USERS u ON f.USER_ID = u.USER_ID
        WHERE f.FREEBOARD_DELETED_YN = 'N'
        <if test="keyword != null and keyword != ''">
            AND (
            f.FREEBOARD_TITLE LIKE CONCAT('%', #{keyword}, '%')
            OR f.FREEBOARD_PLAIN_TEXT LIKE CONCAT('%', #{keyword}, '%')
            OR u.USER_NICKNAME LIKE CONCAT('%_
            OR t.TAG_NAME LIKE CONCAT('%', #{keyword}, '%')
            )
        </if>
    </select>

    <!-- ========================= -->
    <!-- 상세 조회용 resultMap -->
    <!-- ========================= -->
    <resultMap id="FreeboardDetailResponseMap" type="kr.or.kosa.backend.freeboard.dto.FreeboardDetailResponseDto">
        <id property="freeboardId" column="FREEBOARD_ID"/>
        <result property="userId" column="USER_ID"/>
        <result property="userNickname" column="USER_NICKNAME"/>
        <result property="freeboardTitle" column="FREEBOARD_TITLE"/>
        <result property="freeboardContent" column="FREEBOARD_CONTENT"/>
        <result property="freeboardClick" column="FREEBOARD_CLICK"/>
        <result property="likeCount" column="LIKE_COUNT"/>
        <result property="freeboardImage" column="FREEBOARD_IMAGE"/>
        <result property="freeboardRepresentImage" column="FREEBOARD_REPRESENT_IMAGE"/>
        <result property="freeboardCreatedAt" column="FREEBOARD_CREATED_AT"/>
    </resultMap>

    <!-- ========================= -->
    <!-- 게시글 상세 조회 -->
    <!-- ========================= -->
    <select id="selectById" resultMap="FreeboardDetailResponseMap">
        SELECT
        f.FREEBOARD_ID,
        f.USER_ID,
        f.FREEBOARD_TITLE,
        f.FREEBOARD_CONTENT,
        f.FREEBOARD_CLICK,
        f.FREEBOARD_IMAGE,
        f.FREEBOARD_REPRESENT_IMAGE,
        f.FREEBOARD_CREATED_AT,
        u.USER_NICKNAME,

        -- 좋아요 개수
        COALESCE(
        (
        SELECT COUNT(*)
        FROM `LIKE` l
        WHERE l.REFERENCE_TYPE = 'POST_FREEBOARD'
        AND l.REFERENCE_ID = f.FREEBOARD_ID
        ),
        0
        ) AS LIKE_COUNT

        FROM FREEBOARD f
        LEFT JOIN USERS u ON f.USER_ID = u.USER_ID
        WHERE f.FREEBOARD_ID = #{freeboardId}
        AND f.FREEBOARD_DELETED_YN = 'N'
    </select>

    <!-- ========================= -->
    <!-- 게시글 등록 -->
    <!-- ========================= -->
    <insert id="insert"
            parameterType="kr.or.kosa.backend.freeboard.domain.Freeboard"
            useGeneratedKeys="true"
            keyProperty="freeboardId">
        INSERT INTO FREEBOARD (
        USER_ID,
        FREEBOARD_TITLE,
        FREEBOARD_CONTENT,
        FREEBOARD_PLAIN_TEXT,
        FREEBOARD_CLICK,
        FREEBOARD_IMAGE,
        FREEBOARD_REPRESENT_IMAGE,
        FREEBOARD_CREATED_AT,
        FREEBOARD_DELETED_YN
        ) VALUES (
        #{userId},
        #{freeboardTitle},
        #{freeboardContent},
        #{freeboardPlainText},
        0,
        #{freeboardImage},
        #{freeboardRepresentImage},
        NOW(),
        'N'
        )
    </insert>

    <!-- ========================= -->
    <!-- 게시글 수정 -->
    <!-- ========================= -->
    <update id="update" parameterType="kr.or.kosa.backend.freeboard.domain.Freeboard">
        UPDATE FREEBOARD
        SET
        FREEBOARD_TITLE = #{freeboardTitle},
        FREEBOARD_CONTENT = #{freeboardContent},
        FREEBOARD_PLAIN_TEXT = #{freeboardPlainText},
        FREEBOARD_IMAGE = #{freeboardImage},
        FREEBOARD_REPRESENT_IMAGE = #{freeboardRepresentImage}
        WHERE FREEBOARD_ID = #{freeboardId}
        AND FREEBOARD_DELETED_YN = 'N'
    </update>

    <!-- ========================= -->
    <!-- 게시글 삭제 (소프트 딜리트) -->
    <!-- ========================= -->
    <update id="delete" parameterType="long">
        UPDATE FREEBOARD
        SET FREEBOARD_DELETED_YN = 'Y'
        WHERE FREEBOARD_ID = #{id}
    </update>

    <!-- ========================= -->
    <!-- 조회수 증가 -->
    <!-- ========================= -->
    <update id="increaseClick" parameterType="long">
        UPDATE FREEBOARD
        SET FREEBOARD_CLICK = FREEBOARD_CLICK + 1
        WHERE FREEBOARD_ID = #{id}
    </update>

    <!-- ========================= -->
    <!-- 전체 게시글 수 -->
    <!-- ========================= -->
    <select id="countAll" resultType="int">
        SELECT COUNT(*)
        FROM FREEBOARD
        WHERE FREEBOARD_DELETED_YN = 'N'
    </select>

</mapper>
