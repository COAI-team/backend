<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.or.kosa.backend.batch.mapper.BoardStatisticsMapper">

    <!-- 결과 매핑 -->
    <resultMap id="dailyStatisticsResultMap" type="kr.or.kosa.backend.batch.dto.DailyBoardStatisticsDto">
        <id property="statisticsId" column="statistics_id"/>
        <result property="statDate" column="stat_date"/>
        <result property="boardType" column="board_type"/>
        <result property="postCount" column="post_count"/>
        <result property="totalViews" column="total_views"/>
        <result property="avgViews" column="avg_views"/>
        <result property="deletedPostCount" column="deleted_post_count"/>
        <result property="createdAt" column="created_at"/>
    </resultMap>

    <!-- 자유게시판 일간 통계 집계 -->
    <select id="aggregateFreeboardStatistics" resultMap="dailyStatisticsResultMap">
        SELECT
            #{targetDate} AS stat_date,
            'free' AS board_type,
            COUNT(*) AS post_count,
            COALESCE(SUM(freeboard_click), 0) AS total_views,
            COALESCE(AVG(freeboard_click), 0) AS avg_views,
            SUM(CASE WHEN freeboard_deleted_yn = 'Y' THEN 1 ELSE 0 END) AS deleted_post_count
        FROM freeboard
        WHERE DATE(freeboard_created_at) = #{targetDate}
    </select>

    <!-- 코드게시판 일간 통계 집계 -->
    <select id="aggregateCodeboardStatistics" resultMap="dailyStatisticsResultMap">
        SELECT
            #{targetDate} AS stat_date,
            'code' AS board_type,
            COUNT(*) AS post_count,
            COALESCE(SUM(code_board_click), 0) AS total_views,
            COALESCE(AVG(code_board_click), 0) AS avg_views,
            SUM(CASE WHEN code_board_deleted_yn = 'Y' THEN 1 ELSE 0 END) AS deleted_post_count
        FROM code_board
        WHERE DATE(code_board_created_at) = #{targetDate}
    </select>

    <!-- 알고리즘게시판 일간 통계 집계 -->
    <select id="aggregateAlgoboardStatistics" resultMap="dailyStatisticsResultMap">
        SELECT
            #{targetDate} AS stat_date,
            'algo' AS board_type,
            COUNT(*) AS post_count,
            COALESCE(SUM(algorithm_board_click), 0) AS total_views,
            COALESCE(AVG(algorithm_board_click), 0) AS avg_views,
            SUM(CASE WHEN algorithm_board_deleted_yn = 'Y' THEN 1 ELSE 0 END) AS deleted_post_count
        FROM algorithm_board
        WHERE DATE(algorithm_board_created_at) = #{targetDate}
    </select>

    <!-- 통계 데이터 저장 -->
    <insert id="insertDailyStatistics" parameterType="kr.or.kosa.backend.batch.dto.DailyBoardStatisticsDto">
        INSERT INTO daily_board_statistics (
            stat_date,
            board_type,
            post_count,
            total_views,
            avg_views,
            deleted_post_count,
            created_at
        ) VALUES (
            #{statDate},
            #{boardType},
            #{postCount},
            #{totalViews},
            #{avgViews},
            #{deletedPostCount},
            NOW()
        )
    </insert>

    <!-- 통계 존재 여부 확인 -->
    <select id="checkStatisticsExists" resultType="int">
        SELECT COUNT(*)
        FROM daily_board_statistics
        WHERE stat_date = #{statDate}
          AND board_type = #{boardType}
    </select>

    <!-- 기존 통계 삭제 -->
    <delete id="deleteDailyStatistics">
        DELETE FROM daily_board_statistics
        WHERE stat_date = #{statDate}
          AND board_type = #{boardType}
    </delete>

</mapper>