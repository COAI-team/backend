<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.or.kosa.backend.algorithm.mapper.ProblemPoolMapper">

    <!-- ResultMap 정의 -->
    <resultMap id="PoolProblemResultMap" type="kr.or.kosa.backend.algorithm.dto.PoolProblemDto">
        <id property="algoPoolId" column="ALGO_POOL_ID"/>
        <result property="difficulty" column="DIFFICULTY"/>
        <result property="topic" column="TOPIC"/>
        <result property="theme" column="THEME"/>
        <result property="problemContent" column="PROBLEM_CONTENT"/>
        <result property="generatedAt" column="GENERATED_AT"/>
        <result property="generationTimeMs" column="GENERATION_TIME_MS"/>
        <result property="createdAt" column="CREATED_AT"/>
    </resultMap>

    <!-- 기본 컬럼 정의 -->
    <sql id="poolColumns">
        ALGO_POOL_ID,
        DIFFICULTY,
        TOPIC,
        THEME,
        PROBLEM_CONTENT,
        GENERATED_AT,
        GENERATION_TIME_MS,
        CREATED_AT
    </sql>

    <!-- 조합별 문제 1개 조회 + 잠금 (SELECT FOR UPDATE) -->
    <!-- 동시 요청 시 같은 문제 반환 방지를 위해 행 레벨 잠금 사용 -->
    <select id="findAndLockOne" resultMap="PoolProblemResultMap">
        SELECT <include refid="poolColumns"/>
        FROM ALGO_PROBLEM_POOL
        WHERE DIFFICULTY = #{difficulty}
          AND TOPIC = #{topic}
          AND THEME = #{theme}
        LIMIT 1
        FOR UPDATE
    </select>

    <!-- 풀에서 문제 삭제 -->
    <delete id="deleteById">
        DELETE FROM ALGO_PROBLEM_POOL
        WHERE ALGO_POOL_ID = #{algoPoolId}
    </delete>

    <!-- 풀에 문제 추가 -->
    <insert id="insert"
            parameterType="kr.or.kosa.backend.algorithm.dto.PoolProblemDto"
            useGeneratedKeys="true"
            keyProperty="algoPoolId"
            keyColumn="ALGO_POOL_ID">
        INSERT INTO ALGO_PROBLEM_POOL (
            DIFFICULTY,
            TOPIC,
            THEME,
            PROBLEM_CONTENT,
            GENERATED_AT,
            GENERATION_TIME_MS
        ) VALUES (
            #{difficulty},
            #{topic},
            #{theme},
            #{problemContent},
            #{generatedAt},
            #{generationTimeMs}
        )
    </insert>

    <!-- 조합별 현재 개수 조회 -->
    <select id="countByCombination" resultType="int">
        SELECT COUNT(*)
        FROM ALGO_PROBLEM_POOL
        WHERE DIFFICULTY = #{difficulty}
          AND TOPIC = #{topic}
          AND THEME = #{theme}
    </select>

    <!-- 난이도별 현재 개수 조회 -->
    <select id="countByDifficulty" resultType="int">
        SELECT COUNT(*)
        FROM ALGO_PROBLEM_POOL
        WHERE DIFFICULTY = #{difficulty}
    </select>

    <!-- 전체 풀 개수 조회 -->
    <select id="countAll" resultType="int">
        SELECT COUNT(*)
        FROM ALGO_PROBLEM_POOL
    </select>

    <!-- 난이도별 문제 목록 조회 (랜덤 순서) -->
    <!-- 데일리 미션에서 랜덤하게 문제를 선택할 때 사용 -->
    <select id="findByDifficultyRandomly" resultMap="PoolProblemResultMap">
        SELECT <include refid="poolColumns"/>
        FROM ALGO_PROBLEM_POOL
        WHERE DIFFICULTY = #{difficulty}
        ORDER BY RAND()
        LIMIT #{limit}
    </select>

    <!-- 부족한 조합 목록 조회 (스케줄러에서 사용) -->
    <!-- 모든 조합을 체크하여 targetCount보다 적은 조합 반환 -->
    <select id="findDeficientCombinations" resultType="map">
        SELECT
            DIFFICULTY as difficulty,
            TOPIC as topic,
            THEME as theme,
            COUNT(*) as currentCount
        FROM ALGO_PROBLEM_POOL
        GROUP BY DIFFICULTY, TOPIC, THEME
        HAVING COUNT(*) &lt; #{targetCount}
    </select>

</mapper>
