<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.or.kosa.backend.codeboard.mapper.PopularCodeboardMapper">

    <select id="findWeeklyPopularPosts" resultType="kr.or.kosa.backend.codeboard.dto.PopularCodeboardResponseDto">
        SELECT
        c.CODEBOARD_ID as codeboardId,
        c.USER_ID as userId,
        u.USER_NICKNAME as userNickname,
        u.USER_IMAGE as userImage,
        c.CODEBOARD_TITLE as codeboardTitle,
        c.CODEBOARD_PLAIN_TEXT as codeboardPlainText,
        c.CODEBOARD_CLICK as codeboardClick,
        c.CODEBOARD_CREATED_AT as codeboardCreatedAt,
        c.AI_SCORE as aiScore,
        p.LIKE_COUNT as likeCount,
        p.COMMENT_COUNT as commentCount,
        p.POPULARITY_SCORE as popularityScore,
        p.RANKING as ranking
        FROM WEEKLY_POPULAR_CODEBOARD p
        INNER JOIN CODEBOARD c ON p.CODEBOARD_ID = c.CODEBOARD_ID
        INNER JOIN USERS u ON c.USER_ID = u.USER_ID
        WHERE p.WEEK_START_DATE = #{weekStartDate}
        AND c.CODEBOARD_DELETED_YN = 'N'
        ORDER BY p.RANKING ASC
        LIMIT 10
    </select>

    <select id="calculateWeeklyPopularPosts" resultType="kr.or.kosa.backend.codeboard.domain.PopularCodeboard">
        SELECT
        c.CODEBOARD_ID as codeboardId,
        c.CODEBOARD_CLICK as viewCount,
        COALESCE(like_counts.like_count, 0) as likeCount,
        COALESCE(comment_counts.comment_count, 0) as commentCount,
        (c.CODEBOARD_CLICK * 1) +
        (COALESCE(like_counts.like_count, 0) * 5) +
        (COALESCE(comment_counts.comment_count, 0) * 3) as popularityScore
        FROM CODEBOARD c
        LEFT JOIN (
        SELECT REFERENCE_ID, COUNT(*) as like_count
        FROM `LIKE`
        WHERE REFERENCE_TYPE = 'POST_CODEBOARD'
        GROUP BY REFERENCE_ID
        ) like_counts ON c.CODEBOARD_ID = like_counts.REFERENCE_ID
        LEFT JOIN (
        SELECT BOARD_ID, COUNT(*) as comment_count
        FROM `COMMENT`
        WHERE BOARD_TYPE = 'CODEBOARD'
        AND IS_DELETED = FALSE
        GROUP BY BOARD_ID
        ) comment_counts ON c.CODEBOARD_ID = comment_counts.BOARD_ID
        WHERE c.CODEBOARD_DELETED_YN = 'N'
        AND c.CODEBOARD_CREATED_AT BETWEEN #{startDate} AND #{endDate}
        HAVING popularityScore > 0
        ORDER BY popularityScore DESC
        LIMIT #{limit}
    </select>

    <insert id="insertWeeklyPopularPosts">
        INSERT INTO WEEKLY_POPULAR_CODEBOARD (
        CODEBOARD_ID,
        WEEK_START_DATE,
        WEEK_END_DATE,
        VIEW_COUNT,
        LIKE_COUNT,
        COMMENT_COUNT,
        POPULARITY_SCORE,
        RANKING
        )
        VALUES
        <foreach collection="posts" item="post" separator=",">
            (
            #{post.codeboardId},
            #{post.weekStartDate},
            #{post.weekEndDate},
            #{post.viewCount},
            #{post.likeCount},
            #{post.commentCount},
            #{post.popularityScore},
            #{post.ranking}
            )
        </foreach>
    </insert>

    <delete id="deleteOldPopularPosts">
        DELETE FROM WEEKLY_POPULAR_CODEBOARD
        WHERE WEEK_START_DATE &lt; #{cutoffDate}
    </delete>

    <delete id="deleteWeeklyPopularPosts">
        DELETE FROM WEEKLY_POPULAR_CODEBOARD
        WHERE WEEK_START_DATE = #{weekStartDate}
    </delete>

</mapper>