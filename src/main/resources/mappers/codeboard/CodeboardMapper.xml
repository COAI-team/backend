<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.or.kosa.backend.codeboard.mapper.CodeboardMapper">

    <!-- CodeboardListResponseDto용 resultMap -->
    <resultMap id="codeboardListMap" type="kr.or.kosa.backend.codeboard.dto.CodeboardListResponseDto">
        <id property="codeboardId" column="CODEBOARD_ID"/>
        <result property="userId" column="USER_ID"/>
        <result property="userNickname" column="USER_NICKNAME"/>
        <result property="userImage" column="USER_IMAGE"/>
        <result property="analysisId" column="ANALYSIS_ID"/>
        <result property="codeboardTitle" column="CODEBOARD_TITLE"/>
        <result property="codeboardSummary" column="CODEBOARD_SUMMARY"/>
        <result property="codeboardClick" column="CODEBOARD_CLICK"/>
        <result property="codeboardCreatedAt" column="CODEBOARD_CREATED_AT"/>
        <result property="likeCount" column="LIKE_COUNT"/>
        <result property="commentCount" column="COMMENT_COUNT"/>
        <result property="aiScore" column="AI_SCORE"/>
    </resultMap>

    <!-- CodeboardDetailResponseDto용 resultMap -->
    <resultMap id="codeboardDetailMap" type="kr.or.kosa.backend.codeboard.dto.CodeboardDetailResponseDto">
        <id property="codeboardId" column="CODEBOARD_ID"/>
        <result property="userId" column="USER_ID"/>
        <result property="userNickname" column="USER_NICKNAME"/>
        <result property="userImage" column="USER_IMAGE"/>
        <result property="analysisId" column="ANALYSIS_ID"/>
        <result property="codeboardTitle" column="CODEBOARD_TITLE"/>
        <result property="codeboardContent" column="CODEBOARD_CONTENT"/>
        <result property="codeboardClick" column="CODEBOARD_CLICK"/>
        <result property="likeCount" column="LIKE_COUNT"/>
        <result property="commentCount" column="COMMENT_COUNT"/>
        <result property="isLiked" column="IS_LIKED"/>
        <result property="codeboardCreatedAt" column="CODEBOARD_CREATED_AT"/>
    </resultMap>

    <!-- 게시글 목록 조회 -->
    <select id="findPosts" resultMap="codeboardListMap">
        SELECT
        C.CODEBOARD_ID,
        C.USER_ID,
        U.USER_NICKNAME,
        U.USER_IMAGE,
        C.ANALYSIS_ID,
        C.CODEBOARD_TITLE,
        SUBSTRING(C.CODEBOARD_PLAIN_TEXT, 1, 200) AS CODEBOARD_SUMMARY,
        C.CODEBOARD_CLICK,
        C.CODEBOARD_CREATED_AT,
        (SELECT COUNT(*)
        FROM `LIKE`
        WHERE REFERENCE_ID = C.CODEBOARD_ID
        AND REFERENCE_TYPE = 'POST_CODEBOARD') AS LIKE_COUNT,
        (SELECT COUNT(*)
        FROM COMMENT
        WHERE BOARD_ID = C.CODEBOARD_ID
        AND BOARD_TYPE = 'CODEBOARD'
        AND IS_DELETED = 0) AS COMMENT_COUNT,
        CAH.AI_SCORE
        FROM CODEBOARD C
        INNER JOIN USERS U ON C.USER_ID = U.USER_ID
        LEFT JOIN CODE_ANALYSIS_HISTORY CAH
        ON C.ANALYSIS_ID COLLATE utf8mb4_unicode_ci = CAH.ANALYSIS_ID COLLATE utf8mb4_unicode_ci
        WHERE C.CODEBOARD_DELETED_YN = 'N'
        <if test="search.keyword != null and search.keyword != ''">
            AND (
            C.CODEBOARD_TITLE LIKE CONCAT('%', #{search.keyword}, '%')
            OR C.CODEBOARD_PLAIN_TEXT LIKE CONCAT('%', #{search.keyword}, '%')
            OR U.USER_NICKNAME LIKE CONCAT('%', #{search.keyword}, '%')
            OR EXISTS (
            SELECT 1
            FROM CODEBOARD_TAG CT
            WHERE CT.CODEBOARD_ID = C.CODEBOARD_ID
            AND CT.TAG_DISPLAY_NAME LIKE CONCAT('%', #{search.keyword}, '%')
            )
            )
        </if>
        ORDER BY
        <choose>
            <when test="sort.column == 'like_count'">
                LIKE_COUNT ${sort.directionSql}
            </when>
            <when test="sort.column == 'comment_count'">
                COMMENT_COUNT ${sort.directionSql}
            </when>
            <when test="sort.column == 'view_count'">
                C.CODEBOARD_CLICK ${sort.directionSql}
            </when>
            <otherwise>
                C.CODEBOARD_CREATED_AT ${sort.directionSql}
            </otherwise>
        </choose>
        LIMIT #{page.size} OFFSET #{page.offset}
    </select>

    <!-- 게시글 등록 -->
    <insert id="insert" parameterType="kr.or.kosa.backend.codeboard.domain.Codeboard"
            useGeneratedKeys="true" keyProperty="codeboardId">
        INSERT INTO CODEBOARD (
        USER_ID,
        ANALYSIS_ID,
        CODEBOARD_TITLE,
        CODEBOARD_BLOCKS,
        CODEBOARD_PLAIN_TEXT,
        CODEBOARD_CLICK,
        CODEBOARD_CREATED_AT,
        CODEBOARD_DELETED_YN
        ) VALUES (
        #{userId},
        #{analysisId},
        #{codeboardTitle},
        #{codeboardBlocks},
        #{codeboardPlainText},
        0,
        NOW(),
        #{codeboardDeletedYn}
        )
    </insert>

    <!-- 게시글 수정 -->
    <update id="update" parameterType="kr.or.kosa.backend.codeboard.domain.Codeboard">
        UPDATE CODEBOARD
        SET ANALYSIS_ID = #{analysisId},
        CODEBOARD_TITLE = #{codeboardTitle},
        CODEBOARD_BLOCKS = #{codeboardBlocks},
        CODEBOARD_PLAIN_TEXT = #{codeboardPlainText}
        WHERE CODEBOARD_ID = #{codeboardId}
        AND CODEBOARD_DELETED_YN = 'N'
    </update>

    <!-- 게시글 삭제 (소프트 삭제) -->
    <update id="delete">
        UPDATE CODEBOARD
        SET CODEBOARD_DELETED_YN = 'Y'
        WHERE CODEBOARD_ID = #{codeboardId}
    </update>

    <!-- 게시글 상세 조회 -->
    <select id="selectById" resultMap="codeboardDetailMap">
        SELECT
        C.CODEBOARD_ID,
        C.USER_ID,
        U.USER_NICKNAME,
        U.USER_IMAGE,
        C.ANALYSIS_ID,
        C.CODEBOARD_TITLE,
        C.CODEBOARD_BLOCKS AS CODEBOARD_CONTENT,
        C.CODEBOARD_CLICK,
        (SELECT COUNT(*)
        FROM `LIKE` L
        WHERE L.REFERENCE_ID = C.CODEBOARD_ID
        AND L.REFERENCE_TYPE = 'POST_CODEBOARD') AS LIKE_COUNT,
        (SELECT COUNT(*)
        FROM COMMENT CM
        WHERE CM.BOARD_ID = C.CODEBOARD_ID
        AND CM.BOARD_TYPE = 'CODEBOARD'
        AND CM.IS_DELETED = FALSE) AS COMMENT_COUNT,
        <if test="userId != null">
            EXISTS(
            SELECT 1
            FROM `LIKE` L2
            WHERE L2.REFERENCE_ID = C.CODEBOARD_ID
            AND L2.REFERENCE_TYPE = 'POST_CODEBOARD'
            AND L2.USER_ID = #{userId}
            ) AS IS_LIKED,
        </if>
        <if test="userId == null">
            FALSE AS IS_LIKED,
        </if>
        C.CODEBOARD_CREATED_AT
        FROM CODEBOARD C
        LEFT JOIN USERS U ON C.USER_ID = U.USER_ID
        WHERE C.CODEBOARD_ID = #{codeboardId}
        AND C.CODEBOARD_DELETED_YN = 'N'
    </select>

    <!-- 조회수 증가 -->
    <update id="increaseClick">
        UPDATE CODEBOARD
        SET CODEBOARD_CLICK = CODEBOARD_CLICK + 1
        WHERE CODEBOARD_ID = #{codeboardId}
        AND CODEBOARD_DELETED_YN = 'N'
    </update>

    <!-- 게시글 총 개수 조회 -->
    <select id="countPosts" resultType="long">
        SELECT COUNT(*)
        FROM CODEBOARD C
        INNER JOIN USERS U ON C.USER_ID = U.USER_ID
        WHERE C.CODEBOARD_DELETED_YN = 'N'
        <if test="search.keyword != null and search.keyword != ''">
            AND (
            C.CODEBOARD_TITLE LIKE CONCAT('%', #{search.keyword}, '%')
            OR C.CODEBOARD_PLAIN_TEXT LIKE CONCAT('%', #{search.keyword}, '%')
            OR U.USER_NICKNAME LIKE CONCAT('%', #{search.keyword}, '%')
            OR EXISTS (
            SELECT 1
            FROM CODEBOARD_TAG CT
            WHERE CT.CODEBOARD_ID = C.CODEBOARD_ID
            AND CT.TAG_DISPLAY_NAME LIKE CONCAT('%', #{search.keyword}, '%')
            )
            )
        </if>
    </select>

</mapper>