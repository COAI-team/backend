<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.or.kosa.backend.admin.mapper.AdminDashBoardMapper">

    <select id="userSignUpCount" resultType="kr.or.kosa.backend.admin.dto.UserCountSummaryDto">
        SELECT year, month, COUNT(*) AS user_count
        FROM (
            SELECT YEAR (USER_CREATEDAT) AS year, MONTH (USER_CREATEDAT) AS month
            FROM USERS
            WHERE USER_ROLE = 'ROLE_USER'
            AND USER_DELETEDAT IS NULL
            ) AS sub
        GROUP BY year, month
        WITH ROLLUP
        ORDER BY year, month
    </select>


    <select id="todaySignUpCount" resultType="int">
        SELECT COUNT(*) AS today_user_count
        FROM USERS
        WHERE USER_ROLE = 'ROLE_USER'
          AND USER_DELETEDAT IS NULL
          AND DATE (USER_CREATEDAT) = CURDATE()
    </select>

    <select id="todayPaymentSummary" resultType="kr.or.kosa.backend.admin.dto.TodayPaymentSummaryDto">
        select count(*) as today_payment_count,
               IFNULL(sum(amount), 0) as today_total_pay
        from payments
        where DATE (approved_at) = CURDATE()
    </select>

    <select id="paymentSummary" resultType="kr.or.kosa.backend.admin.dto.PaymentSummaryDto">
        SELECT
        YEAR(approved_at) AS year,
        MONTH(approved_at) AS month,
        COUNT(*) AS paymentCount,
        IFNULL(SUM(amount), 0) AS total_pay
        FROM payments
        WHERE status = 'DONE'
        GROUP BY YEAR(approved_at), MONTH(approved_at) WITH ROLLUP
        ORDER BY YEAR(approved_at), MONTH(approved_at)
    </select>

    <select id="languageRanking" resultType="kr.or.kosa.backend.admin.dto.LanguageRankingDto">
        select l.LANGUAGE_NAME, COUNT(t.LANGUAGE_ID) as sub_count  from ALGO_SUBMISSIONS t
        join LANGUAGES l on l.LANGUAGE_ID = t.LANGUAGE_ID
        group by l.LANGUAGE_NAME
        with rollup
        order by sub_count DESC
        limit 6;
    </select>




    <select id="algoSolverRanking" resultType="kr.or.kosa.backend.admin.dto.AlgoSolverRankingDto">
        select t.USER_ID, u.USER_NICKNAME  ,count(t.ALGO_PROBLEM_ID) as algo_solver_count
        from ALGO_SUBMISSIONS t
        join USERS u on t.USER_ID = u.USER_ID
        GROUP by t.USER_ID
        order by algo_solver_count desc
        LIMIT 5
    </select>

    <select id="codeBoardStateTotal" resultType="kr.or.kosa.backend.admin.dto.CodeBoardStateTotalDto">
        SELECT
            JSON_UNQUOTE(JSON_EXTRACT(ANALYANALYSIS_RESULTSIS_RESULT, '$.name')) AS name,
            count(*) as name_count
        FROM CODE_ANALYSIS_HISTORY
        GROUP BY name
        WITH ROLLUP
        ORDER BY name_count DESC
    </select>


    <select id="codeAnalysisRanking" resultType="kr.or.kosa.backend.admin.dto.CodeAnalysisRankingDto">
        SELECT ca.USER_ID, u.USER_NICKNAME, count(ca.USER_ID) as board_count
        FROM CODE_ANALYSIS_HISTORY ca
        JOIN USERS u ON u.USER_ID = ca.USER_ID
        GROUP BY ca.USER_ID
        ORDER BY board_count DESC
        LIMIT 5
    </select>

<!--    배치에 있는 데이터 가져오기-->
    <!--    대시보드 조회 일일 데이터-->
    <select id="selectDailyStatsByRange"
            resultType="kr.or.kosa.backend.admin.dto.dashBoard.SummarySection">
        SELECT
        stat_date,
        total_user_count,
        new_user_count,
        payment_count,
        revenue,
        free_board_post_count,
        code_board_post_count,
        algo_board_post_count,
        total_board_post_count
        FROM ADMIN_DAILY_STATS
        WHERE stat_date BETWEEN #{startDate} AND #{endDate}
        ORDER BY stat_date
    </select>


<!--    최근 한건 -->
    <select id="selectLatestDailyStats"
            resultType="kr.or.kosa.backend.admin.dto.dashBoard.SummarySection">
        SELECT
        stat_date,
        total_user_count,
        new_user_count,
        payment_count,
        revenue,
        free_board_post_count,
        code_board_post_count,
        algo_board_post_count,
        total_board_post_count
        FROM ADMIN_DAILY_STATS
        ORDER BY stat_date DESC
        LIMIT 1
    </select>

<!--    유저 데이터 년도, 월, 가입자수 토탈-->
    <select id="selectAllUserStats"
            resultType="kr.or.kosa.backend.admin.dto.dashBoard.UserStatsDto">
        SELECT
        stat_year,
        stat_month,
        new_user_count,
        total_user_count
        FROM ADMIN_USER_MONTHLY_STATS
        ORDER BY stat_year, stat_month
    </select>

<!--    최근 N월개월만 필요-->
    <select id="selectRecentUserMonthlyStats"
            parameterType="int"
            resultType="kr.or.kosa.backend.admin.dto.dashBoard.UserStatsDto">
        SELECT *
        FROM (
        SELECT
        stat_year,
        stat_month,
        new_user_count,
        total_user_count
        FROM ADMIN_USER_MONTHLY_STATS
        ORDER BY stat_year DESC, stat_month DESC
        LIMIT #{limit}
        ) t
        ORDER BY stat_year, stat_month
    </select>

<!--    결제 내역 통계 년도, 월별, 결제횟수, 총매출-->
    <select id="selectAllSalesStats"
            resultType="kr.or.kosa.backend.admin.dto.dashBoard.SalesStatsDto">
        SELECT
        stat_year,
        stat_month,
        payment_count,
        revenue
        FROM ADMIN_SALES_MONTHLY_STATS
        ORDER BY stat_year, stat_month
    </select>

<!--    최근 몇개월 결제 데이터-->
    <select id="selectMonthlySalesStats"
            parameterType="int"
            resultType="kr.or.kosa.backend.admin.dto.dashBoard.SalesStatsDto">
        SELECT *
        FROM (
        SELECT
        stat_year,
        stat_month,
        payment_count,
        revenue
        FROM ADMIN_SALES_MONTHLY_STATS
        ORDER BY stat_year DESC, stat_month DESC
        LIMIT #{limit}
        ) t
        ORDER BY stat_year, stat_month
    </select>

<!--    전체에서 가장 많이 사용한 언어 5등-->
    <select id="selectLanguageRankingTop5"
            resultType="kr.or.kosa.backend.admin.dto.dashBoard.LanguageRankDto">
        SELECT
        stat_year,
        stat_month,
        language_name,
        SUM(usage_count) AS total_usage
        FROM ADMIN_LANGUAGE_RANKING_MONTHLY
        GROUP BY stat_year, stat_month, language_name
        ORDER BY stat_year DESC, stat_month  DESC , total_usage DESC
    </select>
<!--    월별  알고리즘 많이푼 유저 탑5-->
    <select id="selectAlgoSolveRankingTop5"
            resultType="kr.or.kosa.backend.admin.dto.dashBoard.AlgoSolveRankingDto">
        SELECT
        stat_year,
        stat_month,
        ranking,
        user_email,
        user_nickname,
        solve_count
        FROM ADMIN_ALGO_SOLVE_RANKING_MONTHLY
        WHERE ranking &lt;= 5
        ORDER BY stat_year, stat_month, ranking
    </select>

<!--    월별 코드분석 많이한 유저-->
    <select id="selectCodeAnalysisRankTop5"
            resultType="kr.or.kosa.backend.admin.dto.dashBoard.CodeAnalysisRankDto">
        SELECT
        stat_year,
        stat_month,
        ranking,
        user_email,
        user_nickname,
        analysis_count
        FROM ADMIN_CODE_ANALYSIS_RANKING_MONTHLY
        WHERE ranking &lt;= 5
        ORDER BY stat_year, stat_month, ranking
    </select>

<!--    월별 많이 에러가 난 코드타입-->
    <select id="selectAllAnalysisTypeMonthlyStats"
            resultType="kr.or.kosa.backend.admin.dto.dashBoard.AnalysisTypeMonthlyStatsDto">
        SELECT
        stat_year,
        stat_month,
        analysis_type,
        analysis_count
        FROM ADMIN_ANALYSIS_TYPE_MONTHLY_STATS
        ORDER BY stat_year, stat_month
    </select>
<!--    특정 년도 선택 -->
    <select id="selectAnalysisTypeMonthlyStatsByYear"
            parameterType="int"
            resultType="kr.or.kosa.backend.admin.dto.dashBoard.AnalysisTypeMonthlyStatsDto">
        SELECT
        stat_year,
        stat_month,
        analysis_type,
        analysis_count
        FROM ADMIN_ANALYSIS_TYPE_MONTHLY_STATS
        WHERE stat_year = #{year}
        ORDER BY stat_month
    </select>

<!--    전체 MAU 조회-->
    <select id="selectAllMauMonthlyStats"
            resultType="kr.or.kosa.backend.admin.dto.dashBoard.MauMonthlyStatsDto">
        SELECT
        stat_year,
        stat_month,
        mau_count
        FROM ADMIN_MAU_MONTHLY_STATS
        ORDER BY stat_year, stat_month
    </select>
<!--    특정 년도 MAU-->
    <select id="selectMauMonthlyStatsByYear"
            parameterType="int"
            resultType="kr.or.kosa.backend.admin.dto.dashBoard.MauMonthlyStatsDto">
        SELECT
        stat_year,
        stat_month,
        mau_count
        FROM ADMIN_MAU_MONTHLY_STATS
        WHERE stat_year = #{year}
        ORDER BY stat_month
    </select>


<!--    최근 N개월 MAU-->
    <select id="selectRecentMauMonthlyStats"
            parameterType="int"
            resultType="kr.or.kosa.backend.admin.dto.dashBoard.MauMonthlyStatsDto">
        SELECT
        stat_year,
        stat_month,
        mau_count
        FROM ADMIN_MAU_MONTHLY_STATS
        ORDER BY stat_year DESC, stat_month DESC
        LIMIT #{limit}
    </select>

</mapper>

